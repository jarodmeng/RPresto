<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CTE implementation plan • RPresto</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="CTE implementation plan"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">RPresto</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.4.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="articles/common-table-expressions.html">Common Table Expressions (CTEs)</a>
    <a class="dropdown-item" href="articles/complex-types.html">Translating complex Presto data types</a>
    <a class="dropdown-item" href="articles/primitive-types.html">Primitive Presto data types to R types</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="nav-link" href="https://github.com/prestodb/RPresto/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>CTE implementation plan</h1>
      <small class="dont-index">Source: <a href="https://github.com/prestodb/RPresto/blob/HEAD/CTE_implementation.md"><code>CTE_implementation.md</code></a></small>
    </div>

<div id="cte-implementation-plan" class="section level1">

<div class="section level2">
<h2 id="cte-class-and-storage">CTE class and storage<a class="anchor" aria-label="anchor" href="#cte-class-and-storage"></a></h2>
<p><code>PrestoConnection</code> (S4) has a <code>PrestoSession</code> (RefClass) attached. CTEs are stored in <code>PrestoSession</code> as a named list.</p>
<p><code>PrestoSession</code> has methods to work on CTEs: * Initialization * Get all CTE names * Check if a particular CTE exists * Get a list of CTEs by names * Add a CTE * Remove a CTE</p>
</div>
<div class="section level2">
<h2 id="cte-creation">CTE creation<a class="anchor" aria-label="anchor" href="#cte-creation"></a></h2>
<p>There are two ways to create a CTE: 1. Directly add CTE to <code>PrestoConnection</code>. 2. Call <code>compute(..., cte = TRUE)</code> on a remote table (i.e. <code>tbl_lazy</code>) to save its query as a CTE.</p>
<p>Both of them use the <code>addCTE()</code> method to create the CTE, so we can use <code>grep "addCTE(" * -R</code> to find where CTEs are created.</p>
<ol style="list-style-type: decimal"><li><p><code>dbConnect.R</code> and via <code>PrestoSession.R</code>: direct addition</p></li>
<li><p><code>dbplyr-src.R</code>: <code>compute()</code> addition</p></li>
</ol></div>
<div class="section level2">
<h2 id="cte-usage">CTE usage<a class="anchor" aria-label="anchor" href="#cte-usage"></a></h2>
<p>CTEs are used to “augment” a <code>SELECT</code> query.</p>
<p>There are two scenarios:</p>
<ol style="list-style-type: decimal"><li>
<p>The <code>SELECT</code> query is a <code>lazy_query</code> object (i.e. a remote table’s <code>lazy_query</code> component).</p>
<p>We parse the lazy ops to find all tables used in the query, find matching ones in the connection’s CTEs, wrap them in a <code>WITH</code> clause, and prefix the <code>WITH</code> clause to the original query.</p>
<p>This is done in the <code>db_sql_render()</code> implementation for <code>PrestoConnection</code> and thus show up in all downstream functions and methods that use <code>db_sql_render()</code>.</p>
</li>
<li>
<p>The <code>SELECT</code> query is an arbitrary query wrapped by <code>sql()</code>.</p>
<p>This scenario is only captured in the <code>dbGetQuery()</code> method implementation when the <code>SELECT</code> query is being executed. We capture the “table does not exist” error when it happens, parse the missing table from the error message, find the matching CTE, and use the CTE to retry the query execution.</p>
<p>This is done in the <code>dbGetQuery()</code> implementation for <code>PrestoConnection</code> and thus show up in all downstream functions and methods that use <code>dbGetQuery()</code> . <strong>Notably this means that <code>dbExecute()</code> doesn’t support CTE.</strong></p>
</li>
</ol></div>
<div class="section level2">
<h2 id="cte-utilities">CTE utilities<a class="anchor" aria-label="anchor" href="#cte-utilities"></a></h2>
<p><code>cte.R</code> file</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Onur Ismail Filiz, Sergey Goder, Thomas J. Leeper.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer></div>

  

  

  </body></html>

