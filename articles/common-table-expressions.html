<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="RPresto">
<title>Common Table Expressions (CTEs) • RPresto</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Common Table Expressions (CTEs)">
<meta property="og:description" content="RPresto">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">RPresto</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.4.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/common-table-expressions.html">Common Table Expressions (CTEs)</a>
    <a class="dropdown-item" href="../articles/complex-types.html">Translating complex Presto data types</a>
    <a class="dropdown-item" href="../articles/primitive-types.html">Primitive Presto data types to R types</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="https://github.com/prestodb/RPresto/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Common Table Expressions (CTEs)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/prestodb/RPresto/blob/HEAD/vignettes/common-table-expressions.Rmd"><code>vignettes/common-table-expressions.Rmd</code></a></small>
      <div class="d-none name"><code>common-table-expressions.Rmd</code></div>
    </div>

    
    
<p>The <a href="https://www.essentialsql.com/introduction-common-table-expressions-ctes/" class="external-link">Common
Table Expressions</a> or CTE’s for short are used within SQL databases
to simplify complex joins and subqueries. You can think of them as named
subqueries that can be referenced in other parts of the query, including
other CTEs (i.e. recursive CTEs).</p>
<p>In Presto, CTEs take the form of <a href="https://prestodb.io/docs/current/sql/select.html#with-clause" class="external-link"><code>WITH</code>
clauses</a>. There can be multiple named CTE within the single
<code>WITH</code> clause. They need to be defined before the main
<code>SELECT</code> query.</p>
<p>At the time of this writing (late 2022), <code>DBI</code> APIs don’t
have an official way of implementing CTEs yet. <code>dbplyr</code> just
begins to introduce CTEs into its APIs as an experimental feature. So
our implementation of CTE support in <code>RPresto</code> is very much
avant-garde and should be used with discretion.</p>
<p>We attach CTEs to the <code>PrestoConnection</code> so that they are
available across the queries executed via the connection.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/prestodb/RPresto">RPresto</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a></span><span class="op">)</span></span></code></pre></div>
<p>You can check your <code>RPresto</code> version by running the
<code><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion()</a></code> function. <strong>You need version 1.4.0
or later to use the CTE feature.</strong></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"RPresto"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] '1.4.0'</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-ctes-while-creating-a-prestoconnection">Define CTEs while creating a <code>PrestoConnection</code><a class="anchor" aria-label="anchor" href="#define-ctes-while-creating-a-prestoconnection"></a>
</h2>
<p>You can define and attach CTEs while creating a
<code>PrestoConnection</code>. Here we assume that the user already have
a Presto server with a memory connector set up. If you don’t have such a
server set up, refer to the <a href="https://prestodb.io/docs/current/sql/select.html#with-clause" class="external-link">Presto
documentation</a> for instructions if you want to follow along.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span></span>
<span>  drv <span class="op">=</span> <span class="fu">RPresto</span><span class="fu">::</span><span class="fu"><a href="../reference/Presto.html">Presto</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  host <span class="op">=</span> <span class="st">"http://localhost"</span>,</span>
<span>  port <span class="op">=</span> <span class="fl">8080</span>,</span>
<span>  user <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"USER"</span><span class="op">)</span>,</span>
<span>  catalog <span class="op">=</span> <span class="st">"memory"</span>,</span>
<span>  schema <span class="op">=</span> <span class="st">"default"</span>,</span>
<span>  <span class="co"># Define a testing CTE using dummy VALUES</span></span>
<span>  ctes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"dummy_values"</span> <span class="op">=</span></span>
<span>      <span class="st">"SELECT * FROM (VALUES (1, 'a'), (2, 'b'), (3, 'c') ) AS t (id, name)"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now <code>dummy_values</code> is not an existing permanent table
available in the <code>PrestoConnection</code>. It only exists as a
temporary feature for the connection.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html" class="external-link">db_has_table</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"dummy_values"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>We can read the content of the CTE.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbReadTable.html" class="external-link">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"dummy_values"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 2</span></span></span>
<span><span class="co">#&gt;      id name </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1 a    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2 b    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     3 c</span></span></code></pre></div>
<p>We can also execute arbitrary <code>SELECT</code> queries on top of
the CTE.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT id * 2 AS id_2, name FROM dummy_values"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 2</span></span></span>
<span><span class="co">#&gt;    id_2 name </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     2 a    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     4 b    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     6 c</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="incorporating-ctes-with-dplyr-backend">Incorporating CTEs with <code>dplyr</code> backend<a class="anchor" aria-label="anchor" href="#incorporating-ctes-with-dplyr-backend"></a>
</h2>
<p>Another way of leveraging CTEs in your workflow is to incorporate
them into the <code>dplyr</code> workflow.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># We first copy mtcars to Presto and create a remote table on it</span></span>
<span><span class="va">tbl.mtcars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">mtcars</span>, <span class="st">"test_mtcars"</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">tbl.mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "mpg"  "cyl"  "disp" "hp"   "drat" "wt"   "qsec" "vs"   "am"   "gear"</span></span>
<span><span class="co">#&gt; [11] "carb"</span></span></code></pre></div>
<p>We call a few <code>dplyr</code> verbs on the remote table to mimic a
typical analysis work flow.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl.mtcars.transform</span> <span class="op">&lt;-</span> <span class="va">tbl.mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>hp2 <span class="op">=</span> <span class="fu">pow</span><span class="op">(</span><span class="va">hp</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mean_mpg_by_cyl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mpg</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can see the underlying SQL query generated so far.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl.mtcars.transform</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html" class="external-link">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> *, AVG("mpg") OVER (PARTITION BY "cyl")<span style="color: #0000BB;"> AS </span>"mean_mpg_by_cyl"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span> *, pow("hp", 2.0)<span style="color: #0000BB;"> AS </span>"hp2"</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> "test_mtcars"</span></span>
<span><span class="co">#&gt; ) "q01"</span></span></code></pre></div>
<p>For illustration, let’s say we filter the same transformed table
twice on the <code>cyl</code> field and <code>UNION ALL</code> them
together in the next step.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl.mtcars.union</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">union</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tbl.mtcars.transform</span>, <span class="va">cyl</span> <span class="op">==</span> <span class="fl">4L</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tbl.mtcars.transform</span>, <span class="va">cyl</span> <span class="op">==</span> <span class="fl">8L</span><span class="op">)</span>,</span>
<span>  all <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="va">tbl.mtcars.union</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html" class="external-link">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span> *</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;     <span style="color: #0000BB;">SELECT</span> *, AVG("mpg") OVER (PARTITION BY "cyl")<span style="color: #0000BB;"> AS </span>"mean_mpg_by_cyl"</span></span>
<span><span class="co">#&gt;     <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;       <span style="color: #0000BB;">SELECT</span> *, pow("hp", 2.0)<span style="color: #0000BB;"> AS </span>"hp2"</span></span>
<span><span class="co">#&gt;       <span style="color: #0000BB;">FROM</span> "test_mtcars"</span></span>
<span><span class="co">#&gt;     ) "q01"</span></span>
<span><span class="co">#&gt;   ) "q02"</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">WHERE</span> ("cyl" = 4)</span></span>
<span><span class="co">#&gt; )</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">UNION ALL</span></span></span>
<span><span class="co">#&gt; (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span> *</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;     <span style="color: #0000BB;">SELECT</span> *, AVG("mpg") OVER (PARTITION BY "cyl")<span style="color: #0000BB;"> AS </span>"mean_mpg_by_cyl"</span></span>
<span><span class="co">#&gt;     <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;       <span style="color: #0000BB;">SELECT</span> *, pow("hp", 2.0)<span style="color: #0000BB;"> AS </span>"hp2"</span></span>
<span><span class="co">#&gt;       <span style="color: #0000BB;">FROM</span> "test_mtcars"</span></span>
<span><span class="co">#&gt;     ) "q03"</span></span>
<span><span class="co">#&gt;   ) "q04"</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">WHERE</span> ("cyl" = 8)</span></span>
<span><span class="co">#&gt; )</span></span></code></pre></div>
<p>The underlying SQL query of the transformed table
(i.e. <code>tbl.mtcars.transform</code>) has to be replicated twice in
this step and thus makes the resulting query long and repetitive. It
offers a prime opportunity to simplify using CTEs.</p>
<p>We can “save” the underlying SQL query of the transformed table into
a CTE and use that in the union step by calling the
<code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute()</a></code> function with <code>cte = TRUE</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl.mtcars.transform</span> <span class="op">&lt;-</span> <span class="va">tbl.mtcars.transform</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"mtcars_transform"</span>, cte <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">tbl.mtcars.transform</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html" class="external-link">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; WITH "mtcars_transform" AS (</span></span>
<span><span class="co">#&gt; SELECT *, AVG("mpg") OVER (PARTITION BY "cyl") AS "mean_mpg_by_cyl"</span></span>
<span><span class="co">#&gt; FROM (</span></span>
<span><span class="co">#&gt;   SELECT *, pow("hp", 2.0) AS "hp2"</span></span>
<span><span class="co">#&gt;   FROM "test_mtcars"</span></span>
<span><span class="co">#&gt; ) "q01"</span></span>
<span><span class="co">#&gt; )</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> *</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "mtcars_transform"</span></span></code></pre></div>
<p>Here the content of <code>tbl.mtcars.transform</code> hasn’t changed
at all and we can use the remote table as it is just like before. The
only change underneath is that the underlying logic is now captured and
stored in a CTE. You can almost think of it as saving
<code>tbl.mtcars.transform</code> as a temporary table named
<code>mtcars_transform</code> and pointing the new remote table on that
temporary table. The difference is that no query has actually been
executed yet.</p>
<p>Now we’ve leveraged CTE, the query for the union step looks more
clean and readable.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl.mtcars.union</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">union</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tbl.mtcars.transform</span>, <span class="va">cyl</span> <span class="op">==</span> <span class="fl">4L</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tbl.mtcars.transform</span>, <span class="va">cyl</span> <span class="op">==</span> <span class="fl">8L</span><span class="op">)</span>,</span>
<span>  all <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="va">tbl.mtcars.union</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html" class="external-link">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; WITH "mtcars_transform" AS (</span></span>
<span><span class="co">#&gt; SELECT *, AVG("mpg") OVER (PARTITION BY "cyl") AS "mean_mpg_by_cyl"</span></span>
<span><span class="co">#&gt; FROM (</span></span>
<span><span class="co">#&gt;   SELECT *, pow("hp", 2.0) AS "hp2"</span></span>
<span><span class="co">#&gt;   FROM "test_mtcars"</span></span>
<span><span class="co">#&gt; ) "q01"</span></span>
<span><span class="co">#&gt; )</span></span>
<span><span class="co">#&gt; (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span> *</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> "mtcars_transform"</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">WHERE</span> ("cyl" = 4)</span></span>
<span><span class="co">#&gt; )</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">UNION ALL</span></span></span>
<span><span class="co">#&gt; (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span> *</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> "mtcars_transform"</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">WHERE</span> ("cyl" = 8)</span></span>
<span><span class="co">#&gt; )</span></span></code></pre></div>
<p>We can even create nested CTEs that depend on other CTEs (Presto
calls it chained CTEs). Below we call <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute()</a></code> on
<code>tbl.mtcars.union</code> which already utilizies the
<code>mtcars_transform</code> CTE.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl.mtcars.union</span> <span class="op">&lt;-</span> <span class="va">tbl.mtcars.union</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"mtcars_union"</span>, cte <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">tbl.mtcars.union</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html" class="external-link">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; WITH "mtcars_transform" AS (</span></span>
<span><span class="co">#&gt; SELECT *, AVG("mpg") OVER (PARTITION BY "cyl") AS "mean_mpg_by_cyl"</span></span>
<span><span class="co">#&gt; FROM (</span></span>
<span><span class="co">#&gt;   SELECT *, pow("hp", 2.0) AS "hp2"</span></span>
<span><span class="co">#&gt;   FROM "test_mtcars"</span></span>
<span><span class="co">#&gt; ) "q01"</span></span>
<span><span class="co">#&gt; ),</span></span>
<span><span class="co">#&gt; "mtcars_union" AS (</span></span>
<span><span class="co">#&gt; (</span></span>
<span><span class="co">#&gt;   SELECT *</span></span>
<span><span class="co">#&gt;   FROM "mtcars_transform"</span></span>
<span><span class="co">#&gt;   WHERE ("cyl" = 4)</span></span>
<span><span class="co">#&gt; )</span></span>
<span><span class="co">#&gt; UNION ALL</span></span>
<span><span class="co">#&gt; (</span></span>
<span><span class="co">#&gt;   SELECT *</span></span>
<span><span class="co">#&gt;   FROM "mtcars_transform"</span></span>
<span><span class="co">#&gt;   WHERE ("cyl" = 8)</span></span>
<span><span class="co">#&gt; )</span></span>
<span><span class="co">#&gt; )</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> *</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "mtcars_union"</span></span></code></pre></div>
<p>Now the underlying query of the previous
<code>tbl.mtcars.union</code> is saved into the
<code>mtcars_union</code> CTE which in turn depends on the
<code>mtcars_transform</code> CTE.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Onur Ismail Filiz, Sergey Goder, Thomas J. Leeper.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
